---
title: "Short-term impacts of island restoration on seabirds in Gwaii Haanas (Feb. 07 update)"
knit: (function(inputFile, encoding) { 
      out_dir <- 'reports';
      ext <- '.html';
      rmarkdown::render(inputFile,
                        encoding=encoding, 
                        output_file=file.path(dirname(inputFile), out_dir,  paste('GH-acoustic-Report-', lubridate::date(Sys.time()), ext, sep = ''))) })
output:
  html_document:
    fig_caption: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=F, warning=F,message=F,results="hide", prompt=F, error=F)
```

# ```{r}
# source('cleaning.R')
# source('vocalisations.R')
# source('tasks.R')
# source('voc-plots.R')
# ```

```{r functions, include=FALSE}
# A function for captioning and referencing images
fig <- local({
    i <- 0
    ref <- list()
    list(
        cap=function(refName, text) {
            i <<- i + 1
            ref[[refName]] <<- i
            paste("Figure ", i, ": ", text, sep="")
        },
        ref=function(refName) {
            ref[[refName]]
        })
})
```

## Spatial and temporal coverage
Task 2a) `r task2a`
```{r spatnorth.cov, fig_height = 5, fig.cap = fig$cap("spatnorth.cov", "Location of ARUs and island groups within northern part of study area.")}
source('spatial.R')
mapnorth
```

```{r spatsouth.cov, fig_height = 4, fig.cap = fig$cap("spatsouth.cov", "Location of ARUs and island groups within southern part of study area.")}
mapsouth
```

```{r temp.cov, fig_height = 4, fig.cap = fig$cap("temp.cov", "Temporal coverage by ARUs at sites, 2010-2015. Color indicates island. Note that Bischofs, Arichika, Faraday and Murchison were impact islands.")}
temp.cov
```

# Vocalization Probability
Task 2c) `r task2c`

## Methods
Acoustic Recording Units (ARUs) were located at sites to target breeding habitat of certain species. Some sites had no or very few detections of certain species. For description of vocalization probabilities for each species, we included only those sites deemed to have substantial vocalization activity, defined as any site with a proportion of recordings with detection > 0.01, for a particular species. This approach was taken rather than relying on a priori understanding of habitat and colony locations. For Ancient Murrelets, Cassin's Auklets, Fork-Tailed Storm-Petrels, and Leach's Storm-Petrels: `r ddply(sitedet, .(species), summarise, length = length(species))$length[1]`, `r ddply(sitedet, .(species), summarise, length = length(species))$length[2]`, `r ddply(sitedet, .(species), summarise, length = length(species))$length[3]` and `r ddply(sitedet, .(species), summarise, length = length(species))$length[4]` sites had 50 or more detections, respectively. To describe hourly vocalisation probabilities, we calculated: (1) proportion of recordings with detection of at least one individual in each 10-minute recording period ('p(presence)'); and (2) proportion of recordings with detection of at least two individuals in each recording period ('p(presence > 1)'). We calculated the same metrics (presence, presence of multiple individuals) aggregated by night, for description of nighly vocalization probability. For boxplots, voc.night.prop1proportions were calculated seprately for each site included, which allows visualization fo the variation between sites. We also provide plots that show the mean of proportions at all sites included, with binomial 95% confidence intervals. For description of nightly vocalization probability, separate plots were provided for all years combined, and for each year individually to visually assess whether patterns in vocalization probability varied between years.

## Results

### Daily vocalization probabilities

```{r voc.night.point, fig.cap = fig$cap("voc.night.point", "Daily vocalization probabilities by species. Points represent the mean at all sites included, with 95% binomial confidence intervals.")}
point(voc.night.m, 'hrmin', 'species', 'Time of Night', 'p(presence)', '1 hour', '%H:%M')
```

```{r, voc.night.cov.site, fig.height = 2,  fig.cap = fig$cap("voc.night.cov.site", "Number of sites in each 10-minute recording period.")}
coverage(voc.night.cov, 'hrmin', 'sites', 'species', 'Time of Night', 'p(presence)', '1 hour', '%H:%M')
```

```{r, voc.night.cov.rec, fig.height = 2, fig.cap = fig$cap("voc.night.cov.rec", "Number of recordings in each 10-minute recording period.")}
coverage(voc.night.cov, 'hrmin', 'recordings', 'species', 'Time of Night', 'p(presence)', '1 hour', '%H:%M')
```

### Seasonal vocalization probabilities, all years combined

```{r voc.allyear.point, fig.cap = fig$cap("voc.allyear.point", "Seasonal vocalization probabilities by species. Points represent the mean of all sites included; lines represent 95% confidence intervals.")}
point(voc.allyear.m, 'ynight', 'species')
```

```{r, voc.allyear.cov.site, fig.height = 2,  fig.cap = fig$cap("voc.allyear.cov.site", "Number of sites in each week.")}
coverage(voc.allyear.cov, 'ynight', 'sites', 'species', 'Date', 'Total sites', '1 month', '%b')

```

```{r, voc.allyear.cov.rec, fig.height = 2,  fig.cap = fig$cap("voc.allyear.cov.rec", "Number of recordings in each week.")}
coverage(voc.allyear.cov, 'ynight', 'recordings', 'species', 'Total recordings', 'p(presence)', '1 month', '%b')
```

### Seasonal vocalization probabilities by year
#### Ancient Murrelet
```{r voc.allyear.point, fig.cap = fig$cap("voc.allyear.point", "Seasonal vocalization probabilities by species. Points represent the mean of all sites included; lines represent 95% confidence intervals.")}
point(voc.byyear.anmu.m, 'ynight', 'year')
```

```{r, voc.byyear.cov.anmusite, fig.height = 3.5, fig.cap = fig$cap("voc.byyear.cov.anmusite", "Ancient Murrelet Seasonal vocalization probabilities. Number of sites in each week.")}
coverage(voc.byyear.anmu.cov, 'ynight', 'sites', 'species', 'Date', 'Total sites', '1 month', '%b')
```

```{r, voc.byyear.cov.anmurec, fig.height = 3.5, fig.cap = fig$cap("voc.byyear.cov.anmurec", "Ancient Murrelet Seasonal vocalization probabilities. Number of recordings in each week.")}
coverage(voc.byyear.anmu.cov, 'ynight', 'sites', 'species', 'Date', 'Total sites', '1 month', '%b')

```
#
#### Cassin's Auklet
```{r voc.allyear.point, fig.cap = fig$cap("voc.allyear.point", "Seasonal vocalization probabilities by species. Points represent the mean of all sites included; lines represent 95% confidence intervals.")}
point(voc.byyear, 'ynight', 'species')
```

```{r, voc.byyear.cov.caausite, fig.height = 3.5, fig.cap = fig$cap("voc.byyear.cov.caausite", "Cassin's Auklet Seasonal vocalization probabilities. Number of sites in each week.")}
coverage(voc.byyear.caau.cov, 'ynight', 'sites', 'species', 'Date', 'Total sites', '1 month', '%b')
```

```{r, voc.byyear.cov.caaurec, fig.height = 3.5, fig.cap = fig$cap("voc.byyear.cov.caaurec", "Cassin's Auklet Seasonal vocalization probabilities.Number of recordings in each week.")}
coverage(voc.byyear.caau.cov, 'ynight', 'sites', 'species', 'Date', 'Total sites', '1 month', '%b')
```

#### Fork-Tailed Storm-Petrel
```{r voc.allyear.point, fig.cap = fig$cap("voc.allyear.point", "Seasonal vocalization probabilities by species. Points represent the mean of all sites included; lines represent 95% confidence intervals.")}
point(voc.byyear, 'ynight', 'species')
```

```{r, voc.byyear.cov.ftspsite, fig.height = 3.5, fig.cap = fig$cap("voc.byyear.cov.ftspsite", "Seasonal vocalization probabilities of Fork-tailed Storm-Petrel. Number of sites in each week.")}
coverage(voc.byyear.ftsp.cov, 'ynight', 'sites', 'species', 'Date', 'Total sites', '1 month', '%b')
```

```{r, voc.byyear.cov.ftsprec, fig.height = 3.5, fig.cap = fig$cap("voc.byyear.cov.ftsprec", "Seasonal vocalization probabilities of Fork-tailed Storm-Petrel. Number of recordings in each week.")}
coverage(voc.byyear.ftsp.cov, 'ynight', 'sites', 'species', 'Date', 'Total sites', '1 month', '%b')
```

#### Leach's Storm-Petrel
```{r voc.allyear.point, fig.cap = fig$cap("voc.allyear.point", "Seasonal vocalization probabilities by species. Points represent the mean of all sites included; lines represent 95% confidence intervals.")}
point(voc.byyear, 'ynight', 'species')
```

```{r, voc.byyear.cov.lespsite,fig.height = 3.5, fig.height = 3.5, fig.cap = fig$cap("voc.byyear.cov.lespsite", "Seasonal vocalization probabilities of Leach's Storm-Petrel. Number of sites in each week.")}
coverage(voc.byyear.lesp.cov, 'ynight', 'sites', 'species', 'Date', 'Total sites', '1 month', '%b')
```

```{r, voc.byyear.cov.lesprec, fig.height = 3.5, fig.cap = fig$cap("voc.byyear.cov.lesprec", "Seasonal vocalization probabilities of Leach's Storm-Petrel. Number of recordings in each week.")}
coverage(voc.byyear.lesp.cov, 'ynight', 'sites', 'species', 'Date', 'Total sites', '1 month', '%b')
```

## Appendix A - Boxplots
```{r voc.night, fig.cap = fig$cap("voc.night", "Daily vocalization probabilities by species. Each boxplot summarizes proportion of recordings with detection of one or more individuals.")}
boxplot.n(voc.night, 'hrmin', 'prop1', 'hrmin', 'species', 'p(presence)')
```

```{r voc.night.prop2, fig.cap = fig$cap("voc.night.prop2", "Daily vocalization probabilities by species. Each boxplot summarizes proportion of recordings with detection of two or more individuals.")}
boxplot.n(voc.night, 'hrmin', 'prop2', 'species', 'Time of Night', 'p(presence)', '1 hour', '%H:%M')
```

```{r, voc.allyear.prop1, fig.cap = fig$cap("voc.allyear.prop1", "Seasonal vocalization probabilities by species, all years combined. Each boxplot summarizes proportion of recordings with detection of one or more individuals at each site.")}
boxplot.y(voc.allyear.w, 'week', 'prop1', 'week', 'species')
```

```{r, voc.allyear.prop2, fig.cap = fig$cap("voc.allyear.prop2", "Seasonal vocalization probabilities by species, all years combined. Each boxplot summarizes proportion of recordings with detection of two or more individuals at each site.")}
boxplot(voc.allyear.w, 'week', 'prop2', 'species')
```

```{r, voc.byyear.anmu, fig.cap = fig$cap("voc.byyear.anmu", "Seasonal vocalization probabilities of Ancient Murrelet, 2010-2015. Boxplots summarize proportion of recordings with detection of one or more individuals.")}
boxplot(voc.byyear.anmu.w, 'week', 'prop1', 'species')
```

```{r, voc.byyear.anmu.prop2, fig.cap = fig$cap("voc.byyear.anmu.prop2", "Seasonal vocalization probabilities of Ancient Murrelet, 2010-2015. Boxplots summarize proportion of recordings with detection of two or more individuals.")}
boxplot(voc.byyear.anmu.w, 'week', 'prop2', 'species')
```

```{r, voc.byyear.caau, fig.cap = fig$cap("voc.byyear.caau", "Seasonal vocalization probabilities of Cassin's Auklet, 2010-2015. Boxplots summarize proportion of recordings with detection of one or more individuals.")}
boxplot(voc.byyear.caau.w, 'week', 'prop1', 'species')
```

```{r, voc.byyear.caau.prop2, fig.cap = fig$cap("voc.byyear.caau.prop2", "Seasonal vocalization probabilities of Cassin's Auklet, 2010-2015. Boxplots summarize proportion of recordings with detection of two or more individuals.")}
boxplot(voc.byyear.caau.w, 'week', 'prop2', 'species')
```

```{r, voc.byyear.ftsp, fig.cap = fig$cap("voc.byyear.ftsp", "Seasonal vocalization probabilities of Fork-Tailed Storm-Petrel, 2010-2015. Boxplots summarize proportion of recordings with detection of one or more individuals.")}
boxplot(voc.byyear.ftsp.w, 'week', 'prop1', 'species')
```

```{r, voc.byyear.ftsp.prop2, fig.cap = fig$cap("voc.byyear.ftsp.prop2", "Seasonal vocalization probabilities of Fork-Tailed Storm-Petrel, 2010-2015. Boxplots summarize proportion of recordings with detection of two or more individuals.")}
boxplot(voc.byyear.ftsp.w, 'week', 'prop2', 'species')
```

```{r, voc.byyear.lesp, fig.cap = fig$cap("voc.byyear.lesp", "Seasonal vocalization probabilities of Leach's Storm-Petrel, 2010-2015. Boxplots summarize proportion of recordings with detection of one or more individuals.")}
boxplot(voc.byyear.ftsp.w, 'week', 'prop1', 'species')
```

```{r, voc.byyear.lesp.prop2, fig.cap = fig$cap("voc.byyear.lesp.prop2", "Seasonal vocalization probabilities of Leach's Storm-Petrel, 2010-2015. Boxplots summarize proportion of recordings with detection of two or more individuals.")}
boxplot(voc.byyear.ftsp.w, 'week', 'prop2', 'species')
```

# BACI
```{r}
source('header.R')
source('baci-plots.R')
source('baci-prep.R')
source('baci-models.R')
```
Task 2e) `rtask2e`

This BACI experimental design included multiple control and impact sites, across multiple years before and after impact (i.e. rat eradication). Island groups ('sites') were compared and ARU locations within island groups ('replicates') were averaged for each site:year combination. Two response variables were considered: (1) the proportion of recordings with detection of at least one individual across a common within-season time-period (p(presence)); (2) the proportion of recordings with detection of more than one individual (i.e. overlapping calls) across a common within-season time-period (p(presence > 1). Separate BACI analyses were carried out for each species (`rsp[1]`, `rsp[2]`, `rsp[3]`), eradication phase (Phase 1, Phase 2) and response (p(presence), p(presence > 1)).

Key assumptions:
1. System is in equilibirum before and after impact.
*  This assumption may not be valid as recovery of seabird breeding populations (i.e. colonies) may be more long-term. Thus lack of an effect of eradication between control and impact islands may simply be attributed to short-term nature of the experiment. 
2. Equality of standard deviation at each site-year combination
* Plots show equality of standard deviations
3. observations are indiependent within each site-year combination and across years
* Sites were spaced sufficeintly far apart that this assumption is valid

### Phase 2
In phase 2, eradication of rats took place post-breeding season, 2013. There were two impact sites (Faraday, Murchison) and 4 control sites (Alder, Hotspring/House, Ramsay) and in general, 3 years of sampling before impact (2011, 2012, 2013) and 2 years of sampling after impact (2014, 2015). In total, there were 53 replciate:year combinations (after filtering out replicates that sampled outside of our time-window; see below) and the number of replicates at each site ranged from 2 to 8 (Table 1). Replicates were located at fixed locataions. The sampling design was unbalanced; the number of replicates at each site ranged from 1 to 8, and replicates did not consistently sample in all years (2011-2015).  

First, we constrained our anlaysis to recordings from May 01 - June 15, for each replicate:year combination. This was a period of substantial temporal overlap in replicate sampling and corresponds to a period of high vocalization activity for all species considered (ANMU, CAAU, FTSP; see previous section), which we assume indicates relative equilibrium in the breeding population (i.e. minimal permanent ingress/egress of breeders). This excluded 3 of 56 replicate:year combinations: NBR_21_ALDE:2014 (03-20: 04-26); NBR26_MURC:2012 (06-18: 08-18); NBR34_FARA:2012 (06-18: 08-17) and reduced the total number of 10-minute recoring samples from 326,012 to 117,168.

We fit a mixed effects model using the lme() function within the ___ package. A model was fit with fixed effects period (Before/After), siteclass (Control/Impact), and period:siteclass interaction; random effects included year and island. We used ANOVA (type 3 with Kenward-Roger approximation for degrees of freedom) to determine statistical significance of fixed effects. A p-value < 0.05 for the interacation term indicated presence of a BACI effect. We determined the magnitude of the BACI effect by estimating marginal means and determining 95% Confidence Intervals (CI); CI including 0 indicated no effect.

```{r, tempcov.ph2, fig.height = 3, fig.width = 7, fig.cap = fig$cap("tempcov.ph2", "Temporal coverage of each location with ARU (i.e. 'replicate'). Colour indicates whether replicate is located on a control or impact island. Vertical black lines indiacte sampling window used for analysis.")}
tempcov.baci(seaph2.pre, 'night', 'siteID', 'exp')
  
```

#### Ancient Murrelet
##### Presence of >= 1 individual
```{r kable1}
mutate(mean.anmu, Year = year, year = NULL, yearf = NULL,
      IslandGroup = island, island = NULL,
      SiteClass = exp, exp = NULL,
      Period = period, period = NULL,
      n = n, 
      MeanProportion = mean.prop, mean.prop = NULL,
      SdProportion = sd.prop, sd.prop = NULL
      ) %>%
  select(Year, IslandGroup, SiteClass, Period, n, MeanProportion, SdProportion)
```

```{r, sd.anmu.ph2.1, fig.cap = fig$cap("sd.anmu.ph2.1", "Standard Deviation against mean p(presence) at replicates for each site")}
par(c(mfrow = c(1,2)))
ggplot(mean.anmu) + geom_point(aes(x = mean.prop, y = sd.prop), size = 2.5) + theme_bw()
ggplot(mean.anmu) + geom_point(aes(x = log(mean.prop), y = log(sd.prop)), size = 2.5) + theme_bw()
```

```{r, mean.anmu.ph2.1, fig.cap = fig$cap("mean.anmu.ph2.1", "Mean proportion of recordings with detection of at least one individual at repicates for each island group. Color indicates whether island was control or impact; shape indicates island group")}
ggplot(mean.anmu, aes(x = year, y = mean.prop,  color = exp, shape = island)) + geom_point(size = 3) + geom_line() +
  theme_bw() + geom_vline(xintercept = 2013.5) + labs(x = 'Year', y = 'Mean p(presence)', color = 'Site Class', shape = 'Island Group')
```

Model for demonstration (will not be in final report): 
lmer.anmu.ph2.1 <- lmerTest::lmer(mean.prop ~ period + exp + period:exp + (1|yearf) + (1|island), data = mean.anmu)
summary(lmer.anmu.ph2.1)

```{r kable2}
tab1 <- coef(summary(lm.anmu.ph2.1))
rownames(tab1) <- c('Intercept', 'Period', 'SiteClass', 'Period:SiteClass')
tab1
```

Marginal means
```{r kable3}
tab2 <- summary(lmer.anmu.ph2.1.marg)
colnames(tab2) <- c('SiteClass', 'Period', 'lsMean', 'SE', 'df', 'Lower CI', "Upper CI")
tab2
```
```{r kable4}
contrast(lmer.anmu.ph2.1.marg, list(baci=c(1,-1,-1,1)))
```

```{r kable5}
confint(contrast(lmer.anmu.ph2.1.marg, list(baci=c(1,-1,-1,1))))
```

```{r kable6}
VarCorr(lmer.anmu.ph2.1)
```

No fixed effects within the mixed-effects model were statistically significant (p-values > 0.05; Table 1). The estimated effect of impact is -0.09, i.e. that proprotion of detections with individuals decreased following rat eradication. This is the opposite effect of what was expected. This effect was relatively small and was not statistically significant.
##### Presence of >1 Individual
